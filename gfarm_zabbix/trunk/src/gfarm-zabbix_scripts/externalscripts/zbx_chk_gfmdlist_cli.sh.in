#!/bin/sh

. @ZABBIX_EXTSCRIPTDIR@/zbx_gfarm_utils.inc

# read a configuration file
CONF_FILE=@ZABBIX_EXTSCRIPTDIR@/zbx_chk_gfarm.conf
[ -f $CONF_FILE ] && . $CONF_FILE

# create temporary files
tmpfile=$MDS_LIST_PATH.tmp
errfile=$MDS_LIST_PATH.err
trap "rm -f $tmpfile $errfile; log_err 'killed'; exit 1" 1 2 3 15
rm -f $tmpfile $errfile

# execute 'gfmdhost'.
GFCMD="gfmdhost -l"
$GFCMD > $tmpfile 2> $errfile
GFCMD_EXITCODE=$?
if [ $GFCMD_EXITCODE -ne 0 ]; then
    echo "error: '$GFCMD' failed."
    log_err "'$GFCMD' failed with the exit code $GFCMD_EXITCODE"
    rm -f $tmpfile $errfile
    exit 0
fi

# check whether 'gfmdhost' outputs a list of servers correctly.
if [ ! -s $tmpfile ]; then
    log_warning "'$GFCMD' outputs no data"
    [ -s $errfile ] && head -1 $errfile | syslog_warning
    rm -f $tmpfile $errfile
    exit 0
fi

# for backward compatibility.
echo "gfmdhost -l same."
mv -f $tmpfile $MDS_LIST_PATH
rm -f $errfile

exit 0
