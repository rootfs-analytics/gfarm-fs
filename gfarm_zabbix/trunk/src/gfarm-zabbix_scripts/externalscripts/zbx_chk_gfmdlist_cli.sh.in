#!/bin/sh

. @ZABBIX_EXTSCRIPTDIR@/zbx_gfarm_utils.inc

# read a configuration file
CONF_FILE=@ZABBIX_EXTSCRIPTDIR@/zbx_chk_gfarm.conf
[ -f $CONF_FILE ] && . $CONF_FILE

# create temporary files
TMP_MDS_LIST_PATH=$MDS_LIST_PATH.tmp
ERR_MDS_LIST_PATH=$MDS_LIST_PATH.err
trap "rm -f $TMP_MDS_LIST_PATH $ERR_MDS_LIST_PATH; exit 1" 1 2 3 15
rm -f $TMP_MDS_LIST_PATH $ERR_MDS_LIST_PATH

# execute 'gfmdhost'.
GFCMD="gfmdhost -l"
$GFCMD > $TMP_MDS_LIST_PATH 2> $ERR_MDS_LIST_PATH
GFCMD_EXITCODE=$?
if [ $GFCMD_EXITCODE -ne 0 ]; then
    echo "error: '$GFCMD' failed."
    log_err "'$GFCMD' failed with the exit code $GFCMD_EXITCODE"
    rm -f $TMP_MDS_LIST_PATH $ERR_MDS_LIST_PATH
    exit 0
fi

# check whether 'gfmdhost' outputs a list of servers correctly.
if [ ! -s $TMP_MDS_LIST_PATH ]; then
    log_warning "'$GFCMD' outputs no data"
    [ -s $ERR_MDS_LIST_PATH ] && head -1 $ERR_MDS_LIST_PATH | syslog_warning
    rm -f $TMP_MDS_LIST_PATH $ERR_MDS_LIST_PATH
    exit 0
fi

# for backward compatibility.
echo "gfmdhost -l same."
mv -f $TMP_MDS_LIST_PATH $MDS_LIST_PATH
rm -f $ERR_MDS_LIST_PATH

exit 0
