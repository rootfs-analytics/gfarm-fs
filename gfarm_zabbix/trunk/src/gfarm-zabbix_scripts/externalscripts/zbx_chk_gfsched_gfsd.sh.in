#!/bin/sh

. @ZABBIX_EXTSCRIPTDIR@/zbx_gfarm_utils.inc

# read a configuration file
CONF_FILE=@ZABBIX_EXTSCRIPTDIR@/zbx_chk_gfarm.conf
[ -f $CONF_FILE ] && . $CONF_FILE

# create temporary files
outfile=/tmp/zbx_chk_gfsched_gfsd.$$
errfile=/tmp/zbx_chk_gfsched_gfsd.$$.err
trap "rm -f $outfile $errfile; log_err 'killed'; exit 1" 1 2 3 15
rm -f $outfile $errfile

# execute 'gfsched'
GFCMD="gfsched -M"
$GFCMD > $outfile 2> $errfile
GFCMD_EXITCODE=$?
if [ $GFCMD_EXITCODE -ne 0 ]; then
    echo "error: '$GFCMD' error."
    log_err "'$GFCMD' failed with the exit code $GFCMD_EXITCODE"
    rm -f $outfile $errfile
    exit 0
fi

# check whether 'gfsched' outputs results correctly.
if [ ! -s $outfile ]; then
    echo "error: '$GFCMD' shows no fsn"
    log_warning "'$GFCMD' outputs no data"
    [ -s $errfile ] && head -1 $errfile | syslog_warning
    rm -f $outfile $errfile
    exit 0
fi

while read prefix gfsdhost port listen_aadress; do
    grep ${gfsdhost} $outfile
    if [ $? != 0 ]; then
        echo "error: ${gfsdhost} is not shown on gfsched output."
    fi
done<<EOF
`parse_gfsd_confs "$1"`
EOF

exit 0
