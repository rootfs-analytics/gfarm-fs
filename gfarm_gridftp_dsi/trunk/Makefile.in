# @configure_input@

srcdir = @srcdir@
VPATH = @srcdir@

PACKAGE = @PACKAGE_NAME@
VERSION = @PACKAGE_VERSION@

include @HEADER@

FLAVOR = @FLAVOR@
GFARM = @GFARM@
GLOBUS_LOCATION = @GLOBUS_LOCATION@

SO = libglobus_gridftp_server_gfarm_$(FLAVOR).so
SRC = $(srcdir)/globus_gridftp_server_gfarm.c
ETCFILE = $(srcdir)/Makefile.in $(srcdir)/README.en $(srcdir)/README.ja \
	$(srcdir)/config.h.in $(srcdir)/configure $(srcdir)/configure.ac \
	$(srcdir)/LICENSE

DISTDIR = $(PACKAGE)-$(VERSION)

DSI_OPTIONS =

DSI_CFLAGS = -g -I. $(GLOBUS_CFLAGS) $(DSI_OPTIONS) @CPPFLAGS@ @DEFS@
DSI_INCLUDES = $(GLOBUS_INCLUDES)
DSI_LDFLAGS = $(GLOBUS_LDFLAGS) @LDFLAGS@
DSI_LIBS = @LIBS@

$(SO): $(SRC)
	$(GLOBUS_CC) $(DSI_CFLAGS) $(DSI_INCLUDES) \
		-shared -o $(SO) $(SRC) \
		$(DSI_LDFLAGS) $(DSI_LIBS)

install: $(SO)
	cp -f $(SO) $(GLOBUS_LOCATION)/lib/$(SO)
	@{ (test x`getenforce 2> /dev/null` = x"Enforcing" \
	&& chcon -t texrel_shlib_t $(GLOBUS_LOCATION)/lib/$(SO) ) \
	|| echo -n; }

clean:
	rm -f $(SO)

distclean:
	rm -f $(SO) @HEADER@ Makefile \
		config.h config.log config.status

dist:
	mkdir $(DISTDIR)
	cp -a $(SRC) $(ETCFILE) $(DISTDIR)
	tar -h --owner=root --group=root -zcvf $(DISTDIR).tar.gz $(DISTDIR)
	{ test ! -d $(DISTDIR) \
	|| { find $(DISTDIR) -type d ! -perm -200 -exec chmod u+w {} ';' \
	&& rm -rf $(DISTDIR); }; }
